### 重点总结

1. **目录结构**：
    - T_DIR inode，含 dirent（名称和 inode 号）。
2. **dirlookup**：
    - 找名称匹配条目，返回未锁 inode 和偏移。
3. **死锁防范**：
    - 返回未锁 inode，调用者管理锁顺序。
4. **dirlink**：  
    **dirlink** 中：
    - 写新条目，重复报错，找空位或追加。
5. **偏移管理**：
    - 空位提前停，或用末尾偏移。

---

### 在 xv6 中的体现

- **代码**：
    - kernel/fs.c:527：dirlookup。  
    - kernel/fs.c:554：dirlink。  
    - kernel/fs.h:56：struct dirent。
- **设计**：
    - 睡眠锁和引用计数协调。
---

#### 1. **目录的结构**

- **描述**：
    - 目录是 T_DIR 类型的 inode，数据为 struct dirent 条目，含名称（最多 14 字符）和 inode 号，0 表示空。
- **类比**：
    - 想象一个图书馆的目录书（目录），标“目录类”（T_DIR），内容是书目卡（dirent），每张卡写书名（name）和编号（inum），空卡编号 0。
- **解释**：
    - 目录组织文件索引。

#### 2. **dirlookup 的查找功能**

- **描述**：
    - dirlookup 搜索名称匹配的条目，返回未锁定的 inode 和偏移量，避免死锁。
- **类比**：
    - 读者查目录书（dp）找“小说”（名称），管理员（dirlookup）找到卡片，返回书号（iget），标出卡位（*poff），不锁书（未锁），因锁目录再锁书（.）会卡住。
- **解释**：
    - 返回未锁 inode 防死锁。

#### 3. **死锁问题**

- **描述**：
    - 锁定 dp 后锁定返回的 inode（如 . 或 ..）可能死锁，调用者需先解锁 dp。
- **类比**：
    - 管理员锁目录书（dp），查“当前书架”（.），若再锁自己（同一 inode），卡死。需先放目录锁，再锁书。
- **解释**：
    - 锁顺序需谨慎管理。

#### 4. **dirlink 的链接功能**

- **描述**：
    - dirlink 写入新条目，名称重复则报错，找空位或追加。
- **类比**：
    - 管理员在目录书加卡片（dirlink），查“小说”已存在就报错，找空卡（inum = 0）或加新页（dp->size），写上“小说”和编号。
- **解释**：
    - 添加条目更新目录。

#### 5. **偏移量处理**

- **描述**：
    - dirlink 找到空位提前结束，或用目录末尾偏移写入。
- **类比**：
    - 管理员找到空卡停手（提前结束），或到书尾加卡（off = dp->size），记录位置写卡。
- **解释**：
    - 灵活定位新条目。

---

### 类比举例：图书馆目录管理

- **场景**：
    - 添加文件“book.txt”，查找“book.txt”。
- **过程**：
    1. **目录结构**：
        - 目录书（T_DIR）含卡片：“book.txt, 5”，“空, 0”。
    2. **dirlookup**：
        - 查“book.txt”，找到卡 5，返回 inode 5（未锁），标偏移 0，解锁目录书。
    3. **死锁避免**：
        - 若查“.”（自己），锁目录后再锁 inode 5 卡死，需先解锁目录。
    4. **dirlink**：
        - 加“new.txt, 6”，查无重复，找空卡（偏移 16），写入。
    5. **追加**：
        - 无空卡，写到末尾（off = size）。
- **结果**：
    - 目录正确更新，无死锁。



