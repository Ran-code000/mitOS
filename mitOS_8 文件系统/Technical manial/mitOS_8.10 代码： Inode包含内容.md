### ### 重点总结

1. **Inode 结构**：  **Inode 结构** ：
    - size 和 addrs 存直接和间接块。
2. **bmap**：  **bmap** 中：
    - 返回块号，分配新块。
3. **itrunc**：
    - 释放所有块，size 置零。
4. **readi**：
    - 安全读块数据。
5. **writei**：
    - 写块，更新大小。
6. **设备**：  **设备** ：
    - T_DEV 特殊处理。
7. **stati**：  **状态** ：
    - 提供元数据。

---

### 在 xv6 中的体现

- **代码**：
    - kernel/fs.c:378：bmap。  
    - kernel/fs.c:410：itrunc。  
    - kernel/fs.c:456：readi。  
    - kernel/fs.c:483：writei。  
- **实现**：
    - 直接/间接块分级。
---

#### 1. **磁盘 Inode 的结构**  1. **磁盘 Inode 的结构**

- **描述**：
    - struct dinode 含 size 和 addrs 数组，直接块在前 NDIRECT 个元素，间接块在最后一个元素指向的块中。
- **类比**：
    - 图书馆账簿（dinode）记书页数（size）和书柜号（addrs），前 12 个柜（NDIRECT）直接写，后 256 个柜号写在一张清单（间接块）上。
- **解释**：
    - 分级存储优化空间。

#### 2. **bmap 的功能**

- **描述**：
    - bmap(ip, bn) 返回第 bn 个块号，分配未有块。
- **类比**：
    - 管理员查书第 bn 页在哪柜（bmap），若无柜号，添新柜（分配）。
- **解释**：
    - 映射块号，动态扩展。

#### 3. **bmap 的实现**

- **描述**：
    - 直接块查 addrs，间接块读间接块取号，超限崩溃，遇零分配。
- **类比**：
    - 前 12 页查账簿（直接块），后查清单（间接块），超 268 页报警（崩溃），空号添柜（分配）。
- **解释**：
    - 分段处理，自动扩展。

#### 4. **itrunc 的释放**

- **描述**：
    - 释放直接块、间接块内容和间接块，size 置零。
- **类比**：
    - 管理员删书，扔前 12 个柜的书（直接块）、清单上的书（间接块）和清单本身，页数清零。
- **解释**：
    - 清理文件块。

#### 5. **readi 的读取**

- **描述**：
    - 检查偏移和计数，调整返回字节，从块复制数据。
- **类比**：
    - 读者要第 5-10 页（偏移），超书尾报错或少给，查柜号（bmap）拿书抄给读者。
- **解释**：
    - 安全读取文件内容。

#### 6. **writei 的写入**

- **描述**：
    - 检查大小限制，写块，更新 size。
- **类比**：
    - 读者写第 5-10 页，超限报警，抄到柜里（bmap），记新页数（size）。
- **解释**：
    - 扩展写入文件。

#### 7. **设备特殊处理**

- **描述**：
    - T_DEV 类型跳过文件系统块。
- **类比**：
    - 特殊书（设备）不存柜，直接从设备借。
- **解释**：
    - 区分设备和文件。

#### 8. **stati 的元数据**

- **描述**：
    - 复制 inode 元数据到 stat 结构。
- **类比**：
    - 管理员抄书信息（页数、柜号）给读者（stat）。
- **解释**：
    - 提供文件状态。

---

### 类比举例：图书馆存书

- **场景**：
    - 读者读写书（文件），管理员管理。
- **过程**：
    1. **结构**：  **结构** ：
        - 账簿记书 10 页，前 12 页在柜 1-12，第 13-268 页在清单（柜 13）。
    2. **bmap**：  **bmap** 中：
        - 查第 5 页在柜 5，第 15 页查清单给柜 15，无柜添柜 16。
    3. **itrunc**：  
        **itrunc** 中：
        - 删书，扔柜 1-12 和清单及柜 13。
    4. **readi**：  **准备** ：
        - 读第 5-7 页，查柜抄 3 页。
    5. **writei**：
        - 写第 13-15 页，添柜，更新页数。
- **结果**：
    - 书页有序管理。



