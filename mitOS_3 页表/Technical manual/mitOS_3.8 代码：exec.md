
### 总结重点

1. **exec 功能**:
    - 用 ELF 文件初始化用户地址空间。
2. **加载过程**:
    - 创建新页表，分配内存，加载段，初始化栈。
3. **栈与保护**:
    - 单页栈含参数，下方保护页防溢出。
4. **错误与提交**:
    - 出错释放新页表，成功提交并释放旧页表。
5. **安全性**:
    - 检查 ELF 地址，独立页表隔离内核。
---

#### 1. **exec 的基本功能**

- **概念**:
    - exec（kernel/exec.c:13）用文件系统中的二进制文件（如 /init）初始化用户地址空间。
    - 使用 namei 打开文件，读取 ELF 头（struct elfhdr）和程序节头（struct proghdr）。
- **类比**:
    - 像物业（内核）根据建筑蓝图（ELF 文件）为住户（进程）搭建新房子（地址空间）。
- **示例**:
    - 调用 exec("/init", ["init", 0])：  
        - namei("/init") 打开文件。
        - 读取 ELF 头，检查幻数 0x7F 'E' 'L' 'F'。

---

#### 2. **ELF 文件格式与加载**

- **概念**:
    - ELF 文件包含头和程序节头，描述需要加载到内存的段。
    - exec 用 proc_pagetable 创建新页表，uvmalloc 分配内存，loadseg 加载段。
    - filesz（文件大小）可能小于 memsz（内存大小），差额填充 0。
- **类比**:
    - 像蓝图列出房间（段），物业分配地皮（内存），搬运工（loadseg）把家具（数据）搬进去，空位填填充物（0）。
- **示例**:
    - /init 的程序节头：
        - vaddr=0x0, filesz=2112, memsz=2136, flags=rwx。  
    - uvmalloc(0, 2136) 分配一页（0x80101000）。  
    - loadseg 从文件读取 2112 字节，剩余 24 字节填 0。

---

#### 3. **栈初始化**

- **过程**:
    - 分配一个栈页面（例如 0x7FFFFFF000），复制参数字符串和指针数组。
    - 添加伪返回地址、argc 和 argv。
    - 栈下方设置保护页（PTE_V=0）。
- **类比**:
    - 像给住户准备行李架（栈），放上行李（参数），下面设警戒线（保护页）防止行李掉落。
- **示例**:
    - 栈页 0x7FFFFFF000 - 0x7FFFFFFFFF：
        - 0x7FFFFFFF8: "init".  
        - 0x7FFFFFFF0: [0x7FFFFFFF8, 0]。  
        - 0x7FFFFFFE8: argv=0x7FFFFFFF0, argc=1。  
    - 保护页：0x7FFFFFE000，PTE = 0。  

---

#### 4. **错误处理与提交**

- **过程**:
    - 若出错（如无效段），跳到 bad，释放新页表，返回 -1。
    - 成功后，提交新页表（kernel/exec.c:113），释放旧页表（kernel/exec.c:117）。
- **类比**:
    - 像建房中发现蓝图错误，拆掉重建（释放），确认没问题才入住（提交）。
- **示例**:
    - 段地址溢出，exec 释放页表，返回 -1。
    - 成功加载，satp 更新为新页表，旧页表释放。

---

#### 5. **安全性与风险**

- **概念**:
    - ELF 文件指定加载地址，可能指向内核，需检查避免安全漏洞。
    - xv6 检查溢出（如 ph.vaddr + ph.memsz），并用独立页表隔离内核。
- **类比**:
    - 像住户提交蓝图，物业检查是否侵占公共区域（内核），确保房子（用户空间）不干扰办公楼（内核）。
- **示例**:
    - ELF 指定 vaddr=0x80000000（内核地址），xv6 检查失败，拒绝加载。
    - 旧版本可能允许覆盖内核，新版本用独立页表阻止。

---

### 综合示例

假设执行 exec("/init", ["init", 0])：  

1. **文件加载**:
    - 打开 /init，读取 ELF 头（幻数正确）。
    - 程序节：vaddr=0x0, filesz=2112, memsz=2136。  
    - uvmalloc 分配 0x80101000，loadseg 加载 2112 字节，填 24 个 0。
2. **栈设置**:
    - 栈页：0x7FFFFFF000 -> 0x80102000。
    - 0x7FFFFFFF8: "init", 0x7FFFFFFF0: [0x7FFFFFFF8, 0], 0x7FFFFFFE8: argc=1, argv。  
    - 保护页：0x7FFFFFE000，PTE = 0。  
3. **提交**:
    - 新页表生效，旧页表释放，进程从 0x0 开始执行。
4. **错误情况**:
    - 参数过多，copyout 到 0x7FFFFFEFFF 失败，返回 -1。

---

### 类比补充

- **物业建房**:
    - 住户（进程）给蓝图（ELF），物业（exec）建房（地址空间）。
    - 分配地皮（uvmalloc），搬家具（loadseg），设行李架（栈）和警戒线（保护页）。
    - 检查蓝图（安全性），建好入住（提交）。