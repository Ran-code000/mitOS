
### 总结重点

1. **虚拟地址与物理地址**:
    - 虚拟地址（39 位，Sv39）通过页表映射到物理地址（56 位）。
    - 页大小为 2^12=4096，即 4KB
2. **三级页表**:
    - 27 位索引分三级（9+9+9），节省内存但增加查询开销。
    - 每个 PTE 包含 44 位 PPN（物理页号）和 10 位标志位。
3. **硬件支持**:
    - satp 寄存器指定页表。
    - TLB 缓存加速转换。
4. **标志位**:
    - 控制页面权限（读/写/执行/用户态）。
5. **内核设计**:
    - 映射所有物理内存，便于管理。
6. **术语**:
    - 物理内存是硬件，虚拟内存是抽象。

---

### 知识点分解与示例解释

#### 1. **虚拟地址与物理地址的区别**

- **概念**:
    - 指令（无论是用户态还是内核态）使用的是**虚拟地址**。
    - 物理内存（DRAM）使用的是**物理地址**。
    - 页表硬件负责将虚拟地址映射到物理地址。
- **Sv39 的虚拟地址**:
    - 64 位虚拟地址中，低 39 位用于寻址，高 25 位未使用。
    - 39 位虚拟地址空间大小为 2^39=512 GB
- **物理地址**:
    - Sv39 中物理地址为 56 位（256=64 PB），由 44 位物理页码（PPN）和 12 位页内偏移组成。

---

#### 2. **Sv39 的三级页表结构**

- **逻辑视图**:
    - 页表被视为一个包含 2^27 个页表条目（PTE）的数组。
    - 每个 PTE 包含 44 位 PPN 和 10位标志位（如 PTE_V、PTE_R 等）。
- **实际实现**:
    - 三级树形结构，每级使用虚拟地址的 9 位进行索引。
    - 总共 27 位（39 位中的高 27 位）用于索引：VPN[2]（9 位）、VPN[1]（9 位）、VPN[0]（9 位）。
    - 每级页表页大小为 4096 字节（2^12），包含 512 个 PTE（每个 PTE 8 字节，512×8=4096）。
- **转换过程**:
    - 虚拟地址的低 12 位是页内偏移，直接复制到物理地址。
    - 高 27 位分三级查询页表，找到对应的 PPN。
- **示例**: 假设虚拟地址为 0x0000000123456789（64 位，Sv39 只用低 39 位，即 0x123456789）：
    - 拆分：
        - VPN[2] = 0x12（第 30-38 位） 
        - VPN[1] = 0x345（第 21-29 位）  
        - VPN[0] = 0x67（第 12-20 位）  
        - 偏移 = 0x789（第 0-11 位）
    - 转换过程：
        1. 从 satp 寄存器获取根页表物理地址（如 0x80000000）。
        2. 在根页表（第 0 级）中，用 VPN[2] = 0x12 索引，找到第 18 个 PTE，假设其 PPN = 0x90000，指向下一级页表。
        3. 在第 1 级页表（物理地址 0x90000000），用 VPN[1] = 0x345 索引，找到第 837 个 PTE，假设其 PPN = 0xA0000。
        4. 在第 2 级页表（物理地址 0xA0000000），用 VPN[0] = 0x67 索引，找到第 103 个 PTE，假设其 PPN = 0xB1234。
        5. 最终物理地址 = PPN << 12 | 偏移 = 0xB1234000 | 0x789 = 0xB1234789。

---

#### 3. **页表条目 (PTE) 的作用**

- **结构**:
    - 44 位 PPN + 10 位 标志位（PTE_V, PTE_R, PTE_W, PTE_X, PTE_U 等）。
- **标志位含义**:
    - PTE_V: 是否有效（无效则引发页面故障）。
    - PTE_R/W/X: 可读/可写/可执行。
    - PTE_U: 用户态是否可访问。
- **节省内存**:
    - 三级结构允许跳过未使用的虚拟地址范围，只分配必要的页表页。
- **示例**: 假设一个进程只使用虚拟地址 0x1000 到 0x1FFF（一个页面）：
    - 根页表只需一个 PTE（索引 0），指向第 1 级页表。
    - 第 1 级页表只需一个 PTE，指向第 2 级页表。
    - 第 2 级页表只需一个 PTE，映射到物理页面（如 0x80001000）。
    - 总共 3 个页面（12 KB），而不是单级设计的 2^27×8=1 GB
![[Pasted image 20250317112326.png]]
---

#### 4. **TLB 和性能优化**

- **问题**: 三级查询需要 3 次内存访问，太慢。
- **解决**: CPU 使用 **Translation Look-aside Buffer (TLB)** 缓存最近的虚拟到物理地址映射。
- **示例**:
    - 第一次访问 0x123456789，CPU 查询三级页表，存入 TLB。
    - 下次访问相同地址，直接从 TLB 获取 0xB1234789，无需内存访问。

---

#### 5. **satp 寄存器**

- **作用**: 存储根页表的物理地址，告诉硬件使用哪个页表。
- **多 CPU**: 每个 CPU 有独立的 satp，支持不同进程的独立地址空间。
- **示例**:
    - CPU 0 的 satp = 0x80000000，运行进程 A。
    - CPU 1 的 satp = 0x90000000，运行进程 B。
    - 两个进程的虚拟地址 0x1000 可映射到不同物理地址。

---

#### 6. **内核映射与术语**

- **内核映射**:
    - 内核将所有物理内存映射到其页表，方便直接访问。
    - 示例：虚拟地址 0x80000000 映射到物理地址 0x80000000。
- **术语**:
    - **物理内存**: DRAM 的字节数组。
    - **虚拟地址**: 指令使用的地址。
    - **虚拟内存**: 操作系统提供的抽象机制。
- **示例**:
    - 内核写入 PTE：用虚拟地址 0x80001000（映射到 0x80001000）修改页表。
    - 用户程序访问 0x1000，可能映射到 0xA0001000。

