### 总结重点

1. **分配范围**:
    - 物理内存从内核末尾到 PHYSTOP 用于运行时分配。
2. **页面单位**:
    - 以 4096 字节 即 4KB 页面为单位分配和释放。
3. **链表管理**:
    - 空闲页面用链表记录，分配移除节点，释放添加节点。
4. **动态性**:
    - 支持页表、用户内存、栈和缓冲区的动态分配。
---
#### 1. **物理内存的用途和范围**

- **概念**:
    - 内核在运行时需要为页表、用户内存、内核栈和管道缓冲区分配物理内存。
    - 使用范围：内核代码末尾到 PHYSTOP（例如 0x86400000）之间的物理内存。
- **类比**:
    - 像一个大仓库，内核在仓库里存放各种货物（页表、栈等），从仓库入口（内核末尾）到尽头（PHYSTOP）是可用空间。
- **示例**:
    - 假设内核代码占用 0x80000000 - 0x80100000，PHYSTOP = 0x86400000。  
    - 可分配内存范围：0x80100000 - 0x86400000（约 100 MB）。

---

#### 2. **页面级分配**

- **概念**:
    - 内存以 4096 字节（2122^{12}212）为单位分配和释放，每个单位称为一个页面。
- **类比**:
    - 像仓库里的货架，每个货架固定大小（4096 字节），只能整架拿走或放回，不能拆分。
- **示例**:
    - 分配用户内存：内核请求一个页面，返回 0x80101000 - 0x80101FFF。
    - 释放时，整页归还，不能只释放部分字节。

---

#### 3. **空闲页面链表**

- **概念**:
    - 使用链表记录空闲页面。
    - 分配时从链表移除页面，释放时将页面加回链表。
- **类比**:
    - 像一个“空闲货架清单”，列出仓库里哪些货架没用。需要货架时从清单拿一个，用完放回去。
- **实现细节**:
    - 在 kernel/kalloc.c 中，链表用 struct run 表示：
        
        `struct run { struct run *next; };`
        
    - 全局变量 kmem.freelist 指向链表头。
- **示例**:
    - 初始空闲页面：0x80101000, 0x80102000, 0x80103000。
    - 链表：kmem.freelist -> 0x80101000 -> 0x80102000 -> 0x80103000。

---

#### 4. **分配过程**

- **过程**:
    - 从空闲链表中取出一个页面，移除链表节点。
- **类比**:
    - 像从“空闲货架清单”里挑一个货架，擦掉它的记录，开始使用。
- **示例**:
    - 调用 kalloc()： 
        - 链表：0x80101000 -> 0x80102000 -> 0x80103000。
        - 取走 0x80101000，新链表：0x80102000 -> 0x80103000。
        - 返回 0x80101000 用于内核栈。

---

#### 5. **释放过程**

- **过程**:
    - 将释放的页面加回空闲链表。
- **类比**:
    - 像用完货架后，把它重新写回“空闲货架清单”，供下次使用。
- **示例**:
    - 调用 kfree(0x80101000)：  
        - 原链表：0x80102000 -> 0x80103000。
        - 添加 0x80101000，新链表：0x80101000 -> 0x80102000 -> 0x80103000。  

---

### 综合示例

假设 xv6 管理物理内存，范围 0x80100000 - 0x86400000：

1. **初始化**:
    - 内核末尾 0x80100000，可用页面从 0x80101000 开始。
    - 空闲链表：0x80101000 -> 0x80102000 -> 0x80103000。
2. **分配页面**:
    - 进程需要用户内存，调用 kalloc()：
        - 移除 0x80101000，链表变为 0x80102000 -> 0x80103000。
        - 返回 0x80101000，用于用户页表。
3. **释放页面**:
    - 进程退出，释放 0x80101000，调用 kfree(0x80101000)：
        - 链表更新为 0x80101000 -> 0x80102000 -> 0x80103000。  
4. **再次分配**:
    - 分配内核栈，取出 0x80101000，链表变为 0x80102000 -> 0x80103000。

- **运行时状态**:
    - 已用页面：0x80101000（内核栈）。
    - 空闲页面：0x80102000, 0x80103000, ...。

---

### 类比补充

- **仓库管理**:
    - 仓库总管（内核）维护一个空闲货架清单（链表）。
    - 工人（进程）要货架时，总管从清单拿一个（kalloc）。
    - 工人用完归还，总管加回清单（kfree）。
    - 货架固定 4096 字节，就像标准集装箱，不能拆分。