### 总结重点

1. **独立页表**:
    - 每个进程有单独页表，切换时更新。
2. **地址空间**:
    - 用户内存从 0 到 MAXVA（256 GB）。
3. **内存分配**:
    - 用 kalloc 分配页面，PTE 设置用户权限。
4. **页表特性**:
    - 私有内存、连续虚拟地址、共享蹦床。
5. **栈与保护**:
    - 栈初始化含参数，保护页防止溢出。
---

#### 1. **独立页表与地址空间**

- **概念**:
    - 每个进程有独立的页表，切换进程时更换页表。
    - 用户内存从虚拟地址 0 开始，最大到 MAXVA（256 GB，0x3FFFFFFFFF）。
- **类比**:
    - 像每个住户（进程）有自己的房子地图（页表），房子从门牌号 0 开始，最多能扩展到 256 GB 大小的街区。
- **示例**:
    - 进程 A 页表：VA 0x1000 -> PA 0x80101000。
    - 进程 B 页表：VA 0x1000 -> PA 0x80201000。
    - 切换时，satp 更新为新页表地址。

---

#### 2. **动态内存分配**

- **过程**:
    - 进程请求更多内存，xv6 用 kalloc 分配物理页面。
    - 将 PTE 添加到进程页表，设置标志：PTE_W（可写）、PTE_X（可执行）、PTE_R（可读）、PTE_U（用户态可访问）、PTE_V（有效）。
    - 未使用地址的 PTE 保持 PTE_V=0。
- **类比**:
    - 像住户要扩建房子，管理员（内核）从仓库（物理内存）拿砖块（页面），在地图上标出新房间（PTE），没用的房间留空。
- **示例**:
    - 进程请求 4 KB 内存：
        - kalloc() 返回 0x80102000。  
        - 页表添加：VA 0x2000 -> PPN=0x80102 | PTE_V | PTE_R | PTE_W | PTE_U。  
        - 未映射的 VA 0x3000，PTE = 0。

---

![[Pasted image 20250317154245.png]]
#### 3. **页表的作用**

- **特点**:
    1. **私有内存**: 不同进程的相同虚拟地址映射到不同物理地址。
    2. **连续虚拟地址**: 用户看到连续的 0 - MAXVA，物理内存可不连续。
    3. **共享页面**: 蹦床页面映射到所有进程的地址空间顶部。
- **类比**:
    - 像每个住户的房子编号从 0 开始（虚拟地址），但实际位置（物理地址）不同；所有房子顶楼共用一个瞭望台（蹦床）。
- **示例**:
    - 进程 A：VA 0x1000 -> PA 0x80101000。
    - 进程 B：VA 0x1000 -> PA 0x80201000。
    - 蹦床：VA 0x3FFFFFF000 -> PA 0x80020000（所有进程共享）。

---

![[Pasted image 20250317154302.png]]
#### 4. **栈布局与初始内容**

- **概念**:
    - 栈占一个页面（4096 字节），位于高地址。
    - exec 初始化栈：顶部是命令行参数字符串和指针数组，再往下是 main 的参数（argc, argv）。
- **类比**:
    - 像住户的储物架（栈），最上面放行李标签（参数字符串），下面是行李清单（指针数组），再下面是打开行李的说明书（main 参数）。
- **示例**:
    - 栈页面 VA 0x7FFFFFF000 - 0x7FFFFFFFFF：
        - 0x7FFFFFFF8: "ls"（参数字符串）。
        - 0x7FFFFFFF0: 指针数组 [0x7FFFFFFF8, 0]。  
        - 0x7FFFFFFE8: argv=0x7FFFFFFF0, argc=1。  

---

#### 5. **保护页 (Guard Page)**  

- **概念**:
    - 栈下方是一个无效的保护页（PTE_V=0），防止栈溢出。
    - 溢出时触发页面故障，xv6 不自动扩展栈。
- **类比**:
    - 像储物架下放一个“禁止堆放”区域（保护页），东西掉下去（溢出）就报警（页面故障）。
- **示例**:
    - 栈：VA 0x7FFFFFF000 -> PA 0x80103000，PTE = PTE_V | PTE_R | PTE_W | PTE_U。  
    - 保护页：VA 0x7FFFFFE000，PTE = 0。  
    - 栈溢出到 0x7FFFFFEFFF，触发异常。

---

### 综合示例

假设进程 A 执行 exec("ls", ["ls", 0])：  

1. **页表设置**:
    - 代码：VA 0x1000 -> PA 0x80101000。
    - 栈：VA 0x7FFFFFF000 -> PA 0x80102000。
    - 保护页：VA 0x7FFFFFE000，PTE = 0。  
    - 蹦床：VA 0x3FFFFFF000 -> PA 0x80020000。
2. **内存分配**:
    - 请求额外内存，kalloc() 返回 0x80103000。
    - 页表更新：VA 0x2000 -> PPN=0x80103 | PTE_V | PTE_R | PTE_W | PTE_U。  
3. **栈初始化**:
    - 0x7FFFFFFF8: "ls".  
    - 0x7FFFFFFF0: [0x7FFFFFFF8, 0]。  
    - 0x7FFFFFFE8: argv=0x7FFFFFFF0, argc=1。  
4. **栈溢出**:
    - 函数递归溢出到 0x7FFFFFEFFF，触发页面故障，进程终止。

---

### 类比补充

- **小区管理**:
    - 每个住户（进程）有独立地图（页表），从 0 号房开始。
    - 管理员（内核）分配砖块（页面），标在地图上。
    - 顶楼瞭望台（蹦床）大家共用，储物架（栈）下有警戒线（保护页）。